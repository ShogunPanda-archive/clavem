<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Clavem::Authorizer
  
    &mdash; Documentation by YARD 0.8.6.2
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (A)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Clavem.html" title="Clavem (module)">Clavem</a></span></span>
     &raquo; 
    <span class="title">Authorizer</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Clavem::Authorizer
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Clavem::Authorizer</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">R18n::Helpers</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/clavem/authorizer.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>A class to handle oAuth authorizations.</p>


  </div>
</div>
<div class="tags">
  

</div>



  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#command-instance_method" title="#command (instance method)">- (String) <strong>command</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The command to open the URL.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#host-instance_method" title="#host (instance method)">- (String) <strong>host</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The host address on which listening for replies.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#i18n-instance_method" title="#i18n (instance method)">- (Object) <strong>i18n</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns the value of attribute i18n.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#localizer-instance_method" title="#localizer (instance method)">- (R18N::Translation) <strong>localizer</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A localizer object.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#port-instance_method" title="#port (instance method)">- (Fixnum) <strong>port</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The port on which listening for replies.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#response_handler-instance_method" title="#response_handler (instance method)">- (Proc) <strong>response_handler</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A Ruby block to handle response and check for success.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#status-instance_method" title="#status (instance method)">- (Object) <strong>status</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns the value of attribute status.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#template-instance_method" title="#template (instance method)">- (String) <strong>template</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Alternative template to show progress in user&#8217;s browser.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#timeout-instance_method" title="#timeout (instance method)">- (Fixnum) <strong>timeout</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The amount of milliseconds to wait for response from the remote endpoint before returning a failure.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#title-instance_method" title="#title (instance method)">- (String) <strong>title</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The title for response template.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#token-instance_method" title="#token (instance method)">- (Symbol) <strong>token</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The status of the request.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#url-instance_method" title="#url (instance method)">- (String) <strong>url</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The URL where to send the user to start authorization..</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#instance-class_method" title="instance (class method)">+ (Authorizer) <strong>instance</strong>(host = &quot;localhost&quot;, port = 2501, command = nil, title = nil, template = nil, timeout = 0, force = false, &amp;response_handler) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns a unique (singleton) instance of the authorizer.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#authorize-instance_method" title="#authorize (instance method)">- (Authorizer) <strong>authorize</strong>(url) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Starts the authorization flow.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#callback_url-instance_method" title="#callback_url (instance method)">- (String) <strong>callback_url</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns the callback_url for this authorizer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#default_response_handler-instance_method" title="#default_response_handler (instance method)">- (String|nil) <strong>default_response_handler</strong>(authorizer, request, response) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Handles a response from the remote endpoint.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Authorizer) <strong>initialize</strong>(host = &quot;localhost&quot;, port = 2501, command = nil, title = nil, template = nil, timeout = 0, &amp;response_handler) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Creates a new authorizer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#localize-instance_method" title="#localize (instance method)">- (R18n::Translation) <strong>localize</strong>(locale = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Set the current locale for messages.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Clavem::Authorizer (class)">Authorizer</a></span></tt>) <strong>initialize</strong>(host = &quot;localhost&quot;, port = 2501, command = nil, title = nil, template = nil, timeout = 0, &amp;response_handler) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Creates a new authorizer.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>host</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;localhost&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The host address on which listening for replies. Default is <code>localhost</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>port</span>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>2501</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The port on which listening for replies. Default is <code>2501</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>command</span>
      
      
        <span class='type'>(<tt>String|nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The command to open the URL. <code>{{URL}}</code> is replaced with the specified URL. Default is <code>open "{{URL}}"</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>title</span>
      
      
        <span class='type'>(<tt>String|nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The title for response template. Default is <code>Clavem Authorization</code></p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>template</span>
      
      
        <span class='type'>(<tt>String|nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Alternative template to show progress in userâ€™s browser.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>timeout</span>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is <code>0</code>, which means <em>disabled</em>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>response_handler</span>
      
      
        <span class='type'>(<tt>Proc</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A Ruby block to handle response and check for success. See <span class='object_link'><a href="#default_response_handler-instance_method" title="Clavem::Authorizer#default_response_handler (method)">#default_response_handler</a></span>.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 91</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
  <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

  <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
  <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
  <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

  <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

  <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
  <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
  <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="command=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="command-instance_method">
  
    - (<tt>String</tt>) <strong>command</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The command to open the URL. <code>{{URL}}</code> is replaced with the specified URL. Default is <code>open "{{URL}}"</code>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The command to open the URL. <code>{{URL}}</code> is replaced with the specified URL. Default is <code>open "{{URL}}"</code>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="host=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="host-instance_method">
  
    - (<tt>String</tt>) <strong>host</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The host address on which listening for replies. Default is <code>localhost</code>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The host address on which listening for replies. Default is <code>localhost</code>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="i18n=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="i18n-instance_method">
  
    - (<tt>Object</tt>) <strong>i18n</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns the value of attribute i18n</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


62
63
64</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 62</span>

<span class='kw'>def</span> <span class='id identifier rubyid_i18n'>i18n</span>
  <span class='ivar'>@i18n</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="localizer=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="localizer-instance_method">
  
    - (<tt>R18N::Translation</tt>) <strong>localizer</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>A localizer object.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>R18N::Translation</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A localizer object.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="port=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="port-instance_method">
  
    - (<tt>Fixnum</tt>) <strong>port</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The port on which listening for replies. Default is <code>2501</code>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The port on which listening for replies. Default is <code>2501</code>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="response_handler=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="response_handler-instance_method">
  
    - (<tt>Proc</tt>) <strong>response_handler</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>A Ruby block to handle response and check for success. @see <span class='object_link'><a href="#default_response_handler-instance_method" title="Clavem::Authorizer#default_response_handler (method)">#default_response_handler</a></span>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Proc</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A Ruby block to handle response and check for success. @see <span class='object_link'><a href="#default_response_handler-instance_method" title="Clavem::Authorizer#default_response_handler (method)">#default_response_handler</a></span>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="status=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="status-instance_method">
  
    - (<tt>Object</tt>) <strong>status</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns the value of attribute status</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 61</span>

<span class='kw'>def</span> <span class='id identifier rubyid_status'>status</span>
  <span class='ivar'>@status</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="template=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="template-instance_method">
  
    - (<tt>String</tt>) <strong>template</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Alternative template to show progress in userâ€™s browser.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Alternative template to show progress in userâ€™s browser.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="timeout=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="timeout-instance_method">
  
    - (<tt>Fixnum</tt>) <strong>timeout</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is <code>0</code>, which means <em>disabled</em>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is <code>0</code>, which means <em>disabled</em>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="title=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="title-instance_method">
  
    - (<tt>String</tt>) <strong>title</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The title for response template. Default is <code>Clavem Authorization</code>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The title for response template. Default is <code>Clavem Authorization</code>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="token=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="token-instance_method">
  
    - (<tt>Symbol</tt>) <strong>token</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The status of the request. Can be <code>:success</code>, <code>:denied</code>, <code>:failure</code> and <code>:waiting</code>.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The status of the request. Can be <code>:success</code>, <code>:denied</code>, <code>:failure</code> and <code>:waiting</code>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="url=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="url-instance_method">
  
    - (<tt>String</tt>) <strong>url</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The URL where to send the user to start authorization..</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The URL where to send the user to start authorization..</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 50</span>

<span class='kw'>class</span> <span class='const'>Authorizer</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>Helpers</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:url</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:host</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:port</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:command</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:title</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:template</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:timeout</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:response_handler</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:token</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:status</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:i18n</span>

  <span class='comment'># Returns a unique (singleton) instance of the authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @param force [Boolean] If to force recreation of the instance.
</span>  <span class='comment'># @return [Authorizer] The unique (singleton) instance of the authorizer.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
    <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@instance</span>
  <span class='kw'>end</span>

  <span class='comment'># Creates a new authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param host [String] The host address on which listening for replies. Default is `localhost`.
</span>  <span class='comment'># @param port [Fixnum] The port on which listening for replies. Default is `2501`.
</span>  <span class='comment'># @param command [String|nil] The command to open the URL. `{{URL}}` is replaced with the specified URL. Default is `open &quot;{{URL}}&quot;`.
</span>  <span class='comment'># @param title [String|nil] The title for response template. Default is `Clavem Authorization`
</span>  <span class='comment'># @param template [String|nil] Alternative template to show progress in user's browser.
</span>  <span class='comment'># @param timeout [Fixnum] The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is `0`, which means *disabled*.
</span>  <span class='comment'># @param response_handler [Proc] A Ruby block to handle response and check for success. See {#default_response_handler}.
</span>  <span class='comment'># @return [Authorizer] The new authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_localize'>localize</span>

    <span class='ivar'>@host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@port</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@command</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@title</span> <span class='op'>=</span> <span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@template</span> <span class='op'>=</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
    <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span>
    <span class='ivar'>@response_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_response_handler'>response_handler</span>

    <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>

    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>
    <span class='ivar'>@compiled_template</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>ERB</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@template</span><span class='rparen'>)</span>
    <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Starts the authorization flow.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param url [String] The URL where to send the user to start authorization.
</span>  <span class='comment'># @return [Authorizer] The authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

    <span class='kw'>begin</span>
      <span class='comment'># Setup stuff
</span>      <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

      <span class='comment'># Open the endpoint then start the server
</span>      <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
    <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_cleanup'>cleanup</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># Returns the callback_url for this authorizer.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String] The callback_url for this authorizer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Handles a response from the remote endpoint.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Authorizer] authorizer The current authorizer.
</span>  <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>  <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>  <span class='comment'># @return [String|nil] The oAuth access token. Returning `nil` means *authorization denied*.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
  <span class='kw'>end</span>

  <span class='comment'># Set the current locale for messages.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param locale [String] The new locale. Default is the current system locale.
</span>  <span class='comment'># @return [R18n::Translation] The new translations object.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>
    <span class='comment'># sanitize_arguments
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_sanitize_arguments'>sanitize_arguments</span>
      <span class='ivar'>@host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@host</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@port</span> <span class='op'>=</span> <span class='int'>2501</span> <span class='kw'>if</span> <span class='ivar'>@port</span><span class='period'>.</span><span class='id identifier rubyid_to_integer'>to_integer</span> <span class='op'>&lt;</span> <span class='int'>1</span>
      <span class='ivar'>@command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>open \&quot;{{URL}}\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@title</span> <span class='op'>=</span> <span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_default_title'>default_title</span> <span class='kw'>if</span> <span class='ivar'>@title</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@template</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/template.html.erb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@template</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='kw'>end</span>

    <span class='comment'># Open the remote endpoint
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
      <span class='comment'># Open the oAuth endpoint into the browser
</span>      <span class='kw'>begin</span>
        <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='ivar'>@command</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>{{URL}}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_open_failure'>open_failure</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle interruptions for the process.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handle timeout for the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>
      <span class='kw'>if</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>then</span>
        <span class='ivar'>@timeout_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
          <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='int'>1000</span><span class='rparen'>)</span>
          <span class='ivar'>@timeout_expired</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Prepare the webserver for handling the response.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
      <span class='ivar'>@server</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>HTTPServer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>BindAddress:</span> <span class='ivar'>@host</span><span class='comma'>,</span> <span class='label'>Port:</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='label'>Logger:</span> <span class='const'>WEBrick</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/dev/null</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>AccessLog:</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_mount_proc'>mount_proc</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='op'>|</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='comment'># Handles a response from the remote endpoint.
</span>    <span class='comment'>#
</span>    <span class='comment'># @param [WEBrick::HTTPRequest] request The request that the remote endpoint made to notify authorization status.
</span>    <span class='comment'># @param [WEBrick::HTTPResponse] response The request to send to the browser.
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_dispatch_request'>dispatch_request</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='ivar'>@token</span> <span class='op'>=</span> <span class='ivar'>@response_handler</span> <span class='op'>?</span> <span class='ivar'>@response_handler</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:waiting</span> <span class='kw'>then</span>
        <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='kw'>then</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:success</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:denied</span>
          <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>403</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='ivar'>@compiled_template</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
        <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Cleans up resources
</span>    <span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span>
      <span class='ivar'>@timeout_thread</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='kw'>if</span> <span class='ivar'>@timeout_thread</span>
      <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>if</span> <span class='ivar'>@server</span>
      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>USR2</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>KILL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="instance-class_method">
  
    + (<tt><span class='object_link'><a href="" title="Clavem::Authorizer (class)">Authorizer</a></span></tt>) <strong>instance</strong>(host = &quot;localhost&quot;, port = 2501, command = nil, title = nil, template = nil, timeout = 0, force = false, &amp;response_handler) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a unique (singleton) instance of the authorizer.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>host</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;localhost&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The host address on which listening for replies. Default is <code>localhost</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>port</span>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>2501</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The port on which listening for replies. Default is <code>2501</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>command</span>
      
      
        <span class='type'>(<tt>String|nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The command to open the URL. <code>{{URL}}</code> is replaced with the specified URL. Default is <code>open "{{URL}}"</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>title</span>
      
      
        <span class='type'>(<tt>String|nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The title for response template. Default is <code>Clavem Authorization</code></p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>template</span>
      
      
        <span class='type'>(<tt>String|nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Alternative template to show progress in userâ€™s browser.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>timeout</span>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The amount of milliseconds to wait for response from the remote endpoint before returning a failure. Default is <code>0</code>, which means <em>disabled</em>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>response_handler</span>
      
      
        <span class='type'>(<tt>Proc</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A Ruby block to handle response and check for success. See <span class='object_link'><a href="#default_response_handler-instance_method" title="Clavem::Authorizer#default_response_handler (method)">#default_response_handler</a></span>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>force</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>false</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>If to force recreation of the instance.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="Clavem::Authorizer (class)">Authorizer</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The unique (singleton) instance of the authorizer.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


75
76
77
78
79</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 75</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='int'>2501</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_force'>force</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
  <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_force'>force</span>
  <span class='ivar'>@instance</span> <span class='op'>||=</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Authorizer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_template'>template</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_response_handler'>response_handler</span><span class='rparen'>)</span>
  <span class='ivar'>@instance</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="authorize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Clavem::Authorizer (class)">Authorizer</a></span></tt>) <strong>authorize</strong>(url) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Starts the authorization flow.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>url</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The URL where to send the user to start authorization.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="Clavem::Authorizer (class)">Authorizer</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The authorizer.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Exceptions/AuthorizationDenied.html" title="Clavem::Exceptions::AuthorizationDenied (class)">Clavem::Exceptions::AuthorizationDenied</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 117</span>

<span class='kw'>def</span> <span class='id identifier rubyid_authorize'>authorize</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
  <span class='ivar'>@url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
  <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:waiting</span>

  <span class='kw'>begin</span>
    <span class='comment'># Setup stuff
</span>    <span class='id identifier rubyid_setup_webserver'>setup_webserver</span>
    <span class='id identifier rubyid_setup_interruptions_handling'>setup_interruptions_handling</span>
    <span class='id identifier rubyid_setup_timeout_handling'>setup_timeout_handling</span>

    <span class='comment'># Open the endpoint then start the server
</span>    <span class='id identifier rubyid_open_endpoint'>open_endpoint</span>
    <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@timeout_expired</span>
  <span class='kw'>rescue</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Timeout</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_t'>t</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_t'>t</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='ivar'>@status</span> <span class='op'>=</span> <span class='symbol'>:failure</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>Failure</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@i18n</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_response_failure'>response_failure</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_cleanup'>cleanup</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Clavem</span><span class='op'>::</span><span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>AuthorizationDenied</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>if</span> <span class='ivar'>@status</span> <span class='op'>==</span> <span class='symbol'>:denied</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="callback_url-instance_method">
  
    - (<tt>String</tt>) <strong>callback_url</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns the callback_url for this authorizer.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The callback_url for this authorizer.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


149
150
151</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 149</span>

<span class='kw'>def</span> <span class='id identifier rubyid_callback_url'>callback_url</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="default_response_handler-instance_method">
  
    - (<tt>String|nil</tt>) <strong>default_response_handler</strong>(authorizer, request, response) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Handles a response from the remote endpoint.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>authorizer</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="Clavem::Authorizer (class)">Authorizer</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The current authorizer.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>request</span>
      
      
        <span class='type'>(<tt>WEBrick::HTTPRequest</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The request that the remote endpoint made to notify authorization status.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>response</span>
      
      
        <span class='type'>(<tt>WEBrick::HTTPResponse</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The request to send to the browser.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String|nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The oAuth access token. Returning <code>nil</code> means <em>authorization denied</em>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


159
160
161</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 159</span>

<span class='kw'>def</span> <span class='id identifier rubyid_default_response_handler'>default_response_handler</span><span class='lparen'>(</span><span class='id identifier rubyid_authorizer'>authorizer</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>oauth_token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_ensure_string'>ensure_string</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="localize-instance_method">
  
    - (<tt>R18n::Translation</tt>) <strong>localize</strong>(locale = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Set the current locale for messages.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>locale</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The new locale. Default is the current system locale.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>R18n::Translation</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The new translations object.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


167
168
169
170</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clavem/authorizer.rb', line 167</span>

<span class='kw'>def</span> <span class='id identifier rubyid_localize'>localize</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@i18n_locales_path</span> <span class='op'>||=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_absolute_path'>absolute_path</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/../../locales/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>||</span> <span class='symbol'>:en</span><span class='comma'>,</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LANG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_system_locale'>system_locale</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='comma'>,</span> <span class='ivar'>@i18n_locales_path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_clavem'>clavem</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Sat Jul 20 13:46:59 2013 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.6.2 (ruby-1.9.3).
</div>

  </body>
</html>